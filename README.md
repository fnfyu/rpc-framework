
---

# My-Simple-RPCï¼šåˆ†å¸ƒå¼ RPC æ¡†æ¶

## ğŸŒŸ é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäº **Netty 4.2** å¼€å‘çš„é«˜æ€§èƒ½åˆ†å¸ƒå¼è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰æ¡†æ¶ã€‚
æœ¬é¡¹ç›®æ·±åº¦é›†æˆäº† **Spring å®¹å™¨** ä¸ **SPI æ’ä»¶æœºåˆ¶**ï¼Œå®ç°äº†çœŸæ­£çš„æ³¨è§£é©±åŠ¨ï¼ˆAnnotation-Drivenï¼‰å¼€å‘ã€‚æ ¸å¿ƒåŠŸèƒ½æ¶µç›–äº†ç§æœ‰äºŒè¿›åˆ¶åè®®ã€é•¿è¿æ¥é“¾è·¯æ²»ç†ã€è‡ªåŠ¨å®¹é”™é‡è¯•ä»¥åŠæœåŠ¡åŠ¨æ€å‘ç°ã€‚

---

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

* **å…¨è‡ªåŠ¨æ³¨è§£æ³¨å…¥**ï¼šå®¢æˆ·ç«¯ä»…éœ€ä½¿ç”¨ `@RpcReference` æ³¨è§£ï¼Œç”± `BeanPostProcessor` è‡ªåŠ¨æ³¨å…¥ä»£ç†å¯¹è±¡ï¼Œå®ç°é›¶ä¾µå…¥è°ƒç”¨ã€‚
* **é…ç½®åŒ–æ’ä»¶å¼•æ“ (SPI)**ï¼š**ExtensionLoader** å®ç°æ ¸å¿ƒç»„ä»¶ï¼ˆåºåˆ—åŒ–ã€è´Ÿè½½å‡è¡¡ï¼‰çš„å…¨è‡ªåŠ¨è£…é…ã€‚åªéœ€ä¿®æ”¹ `rpc.properties`ï¼Œå³å¯åŠ¨æ€åˆ‡æ¢ç®—æ³•ã€‚
* **é«˜å¯ç”¨é“¾è·¯æ²»ç†**ï¼š
* **åŠ¨æ€å¯»å€**ï¼šé›†æˆ **Zookeeper** å®ç°æœåŠ¡çš„å®æ—¶æ³¨å†Œä¸å‘ç°ã€‚
* **æ•…éšœè½¬ç§»ï¼ˆFailoverï¼‰**ï¼šä»£ç†å±‚å†…ç½® 3 æ¬¡é‡è¯•é€»è¾‘ï¼ŒèŠ‚ç‚¹å®•æœºè‡ªåŠ¨è§¦å‘é‡æ–°å¯»å€ï¼Œä¹Ÿå¯ä¿®æ”¹é…ç½®æ–‡ä»¶æ›´æ”¹ã€‚
* **å¿ƒè·³ä¸å¥åº·ç›‘æµ‹**ï¼šåŸºäº `IdleStateHandler` å®ç°åŒå‘å¿ƒè·³ï¼Œè‡ªåŠ¨å‰”é™¤åƒµå°¸è¿æ¥ã€‚
* **æè‡´æ€§èƒ½è®¾è®¡**ï¼š
* **é•¿è¿æ¥æ± åŒ–**ï¼šä½¿ç”¨ `ChannelProvider` æœºåˆ¶å¤ç”¨ Netty è¿æ¥ï¼Œæå¤§é™ä½é«˜å¹¶å‘ä¸‹çš„æ¡æ‰‹å¼€é”€ã€‚
* **ç§æœ‰äºŒè¿›åˆ¶åè®®**ï¼šåŒ…å«é­”æ•°æ ¡éªŒã€ç‰ˆæœ¬æ§åˆ¶åŠå¤šç§åºåˆ—åŒ–æ”¯æŒï¼Œä»åº•å±‚æœç»ç²˜åŒ…/åŠåŒ…ã€‚
* **æé€Ÿåºåˆ—åŒ–**ï¼šé»˜è®¤é‡‡ç”¨ **Kryo 5.5**ï¼Œæ•°æ®ä½“ç§¯æ›´å°ï¼Œè§£æé€Ÿåº¦æ›´å¿«ã€‚ä¹Ÿå¯ä¿®æ”¹é…ç½®æ–‡ä»¶è¿›è¡Œæ›´æ”¹ã€‚



---

## ğŸ“ åè®®è®¾è®¡ï¼ˆè‡ªå®šä¹‰åŒ…æ ¼å¼ï¼‰

```text
+----------+----------+----------------+------------+---------------+
|  Magic   |  Version | SerializerType |   Length   |      Data     |
| (4 bytes)| (1 byte) |    (1 byte)    | (4 bytes)  |   (N bytes)   |
+----------+----------+----------------+------------+---------------+

```

* **Magic (0xCCBCCBCB)**ï¼šèº«ä»½è¯†åˆ«æš—å·ã€‚
* **SerializerType**ï¼šæ”¯æŒæœåŠ¡ç«¯åŠ¨æ€è¯†åˆ« Codeï¼Œå®ç°â€œçœ‹ç¢Ÿä¸‹èœâ€å¼çš„å…¨è‡ªåŠ¨ååºåˆ—åŒ–ã€‚

---

## ğŸ›  æŠ€æœ¯æ ˆ

* **æ ¸å¿ƒå¼•æ“**ï¼šJava 21 & Spring Boot / Spring Framework
* **ç½‘ç»œé€šä¿¡**ï¼šNetty 4.2
* **æ³¨å†Œä¸­å¿ƒ**ï¼šApache Zookeeper
* **åºåˆ—åŒ–**ï¼šKryo 5.5 / Jackson (JSON)
* **è´Ÿè½½å‡è¡¡**ï¼šRandom / RoundRobin (åŸºäº SPI)

---

## ğŸ“– å¿«é€Ÿä¸Šæ‰‹

### 1. æœåŠ¡ç«¯ï¼šå£°æ˜å¹¶å¼€å¯æœåŠ¡

åªéœ€åœ¨å®ç°ç±»ä¸Šè´´ä¸Š `@RpcService`ï¼Œå‰©ä¸‹çš„æ³¨å†Œé€»è¾‘ç”±æ¡†æ¶è‡ªåŠ¨å®Œæˆã€‚

```java
@RpcService // è‡ªåŠ¨æ‰«æå¹¶æ³¨å†Œè‡³ ZK
public class HelloServiceImpl implements HelloService {
    @Override
    public String hello(String name) {
        return "ä½ å¥½, " + name + "ï¼è¯·æ±‚å·²å¤„ç†ã€‚";
    }
}

```

### 2. å®¢æˆ·ç«¯ï¼šé€æ˜è°ƒç”¨

æ— éœ€æ‰‹åŠ¨ `new` ä»£ç†ï¼Œç›´æ¥é€šè¿‡æ³¨è§£è·å–å®ä¾‹ã€‚

```java
@Service
public class BusinessService {

    @RpcReference // æ¡†æ¶è‡ªåŠ¨æ‰«æå¹¶æ³¨å…¥å…·å¤‡è´Ÿè½½å‡è¡¡ä¸é‡è¯•èƒ½åŠ›çš„ä»£ç†å¯¹è±¡
    private HelloService helloService;

    public void doBusiness() {
        // åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ï¼Œå±è”½å¤æ‚çš„ç½‘ç»œç»†èŠ‚
        String result = helloService.hello("è€äººå®¶");
        System.out.println(">>> å“åº”ç»“æœ: " + result);
    }
}

```

### 3. ä¸€é”®åˆ‡æ¢é…ç½®

åœ¨ `src/main/resources/rpc.properties` ä¸­è°ƒæ•´æ¡†æ¶è¡Œä¸ºï¼š

```properties
rpc.zookeeper.address=127.0.0.1:2181
rpc.serializer.name=kryo
rpc.loadbalance.name=roundRobin
rpc.retry.times=3
```
---

**Author:** [fnfyu]
**Last Updated:** 2026-01-19

---